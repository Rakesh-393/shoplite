<!-- templates/base.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ShopLite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="{% url 'store:product_list' %}">ShopLite</a>
    <div>
      <ul class="navbar-nav ms-auto">
        {% if user.is_authenticated %}
          {% if user.is_staff %}
            <li class="nav-item"><a class="nav-link" href="{% url 'store:dashboard' %}">Dashboard</a></li>
          {% endif %}
          <li class="nav-item"><a class="nav-link" href="#">{{ user.username }}</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'accounts:logout' %}">Logout</a></li>
        {% else %}
          <li class="nav-item"><a class="nav-link" href="{% url 'accounts:login' %}">Login</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'accounts:signup' %}">Signup</a></li>
        {% endif %}
        <li class="nav-item">
          <a class="nav-link position-relative" href="#" onclick="openCartModal()">
            Cart ðŸ›’
            <span id="cartCountBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" {% if cart_count == 0 %}style="display: none;"{% endif %}>
              {{ cart_count }}
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">
  {% block content %}{% endblock %}
</div>

<!-- Cart Modal -->
<div class="modal fade" id="cartModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ðŸ›’ Shopping Cart</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="cartModalBody">
        <!-- Cart items will be loaded here -->
      </div>
      <div class="modal-footer">
        <div class="d-flex justify-content-between w-100">
          <h5>Total: $<span id="modalCartTotal">0.00</span></h5>
          <button type="button" class="btn btn-success">Checkout</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
function openCartModal() {
  {% if user.is_authenticated %}
    fetch('/cart/')
      .then(response => response.json())
      .then(data => {
        displayCartModal(data);
      })
      .catch(error => console.error('Error:', error));
  {% else %}
    window.location.href = '{% url "accounts:login" %}';
  {% endif %}
}

function displayCartModal(data) {
  const cartBody = document.getElementById('cartModalBody');
  const cartTotal = document.getElementById('modalCartTotal');
  
  if (data.cart_items.length === 0) {
    cartBody.innerHTML = '<div class="text-center py-4"><p class="text-muted">Your cart is empty</p></div>';
  } else {
    cartBody.innerHTML = '';
    data.cart_items.forEach(item => {
      cartBody.innerHTML += `
        <div class="row align-items-center mb-3 pb-3 border-bottom">
        <div class="col-md-2">
            <img src="${item.image_url}" alt="${item.name}" class="img-fluid">
          </div>
          <div class="col-md-4">
            <h6 class="mb-1">${item.name}</h6>
            <small class="text-muted">$${item.price} each</small>
          </div>
          <div class="col-md-3 text-center">
            <div class="d-flex align-items-center justify-content-center">
              <button class="btn btn-sm btn-outline-danger me-1" onclick="updateQuantity(${item.id}, 'decrease')">âˆ’</button>
              <span class="mx-2">${item.quantity}</span>
              <button class="btn btn-sm btn-outline-success ms-1" onclick="updateQuantity(${item.id}, 'increase')">+</button>
            </div>
          </div>
          <div class="col-md-3 text-end">
            <strong>$${item.total}</strong>
          </div>
        </div>
      `;
    });
  }
  
  cartTotal.textContent = data.cart_total;
  
  const cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
  cartModal.show();
}

function updateCartCount(count) {
  const badge = document.getElementById('cartCountBadge');
  if (count > 0) {
    badge.textContent = count;
    badge.style.display = 'inline';
  } else {
    badge.style.display = 'none';
  }
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function updateQuantity(itemId, action) {
  const csrftoken = getCookie('csrftoken');
  
  fetch(`/update-cart/${itemId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrftoken,
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: `action=${action}`
  })
  .then(response => response.json())
  .then(data => {
    // Update cart modal content without closing/reopening
    const cartBody = document.getElementById('cartModalBody');
    const cartTotal = document.getElementById('modalCartTotal');
    
    if (data.cart_items.length === 0) {
      cartBody.innerHTML = '<div class="text-center py-4"><p class="text-muted">Your cart is empty</p></div>';
    } else {
      cartBody.innerHTML = '';
      data.cart_items.forEach(item => {
        cartBody.innerHTML += `
          <div class="row align-items-center mb-3 pb-3 border-bottom">
          <div class="col-md-2">
              <img src="${item.image_url}" alt="${item.name}" class="img-fluid">
            </div>
            <div class="col-md-4">
              <h6 class="mb-1">${item.name}</h6>
              <small class="text-muted">$${item.price} each</small>
            </div>
            <div class="col-md-3 text-center">
              <div class="d-flex align-items-center justify-content-center">
                <button class="btn btn-sm btn-outline-danger me-1" onclick="updateQuantity(${item.id}, 'decrease')">âˆ’</button>
                <span class="mx-2">${item.quantity}</span>
                <button class="btn btn-sm btn-outline-success ms-1" onclick="updateQuantity(${item.id}, 'increase')">+</button>
              </div>
            </div>
            <div class="col-md-3 text-end">
              <strong>$${item.total}</strong>
            </div>
          </div>
        `;
      });
    }
    
    cartTotal.textContent = data.cart_total;
    updateCartCount(data.cart_count);
  })
  .catch(error => console.error('Error:', error));
}
</script>
</body>
</html>
